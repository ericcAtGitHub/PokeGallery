import{G as a,_ as c,o as y}from"./index-D6cM7uU3.js";function g({offset:n,scroll:l,itemStart:o,itemEnd:h,screenSize:t}){const i=l-n-h,e=n+o-t-l;return{before:i,after:e}}function p({target:n,scrollBase:l,top:o,bottom:h,screenHeight:t,padding:i}){const e=g({offset:l||0,scroll:n.scrollY,itemStart:o,itemEnd:h,screenSize:t});return e.before<i&&e.after<i}function I({target:n,left:l,right:o,screenWidth:h,padding:t}){const i=g({offset:0,scroll:n.scrollLeft,itemStart:l,itemEnd:o,screenSize:h});return i.before<t&&i.after<t}class m{constructor(l,o,h){this.setPlayingItem=l,this.isItemSupported=o,this.getPlayTrigger=h,this.scrollBase=0,this.items=[],this.currentPlayingIdx=-1,this.currentItemCount=0,this.lastVideoPlayed=-1,this.itemRatingMap=new Map,this.updateGalleryStructure=({galleryStructure:t,galleryWidth:i,scrollBase:e,options:s})=>{this.galleryWidth=i,this.scrollBase=e,this.playTrigger=this.getPlayTrigger(s),this.videoLoop=s.behaviourParams_item_video_loop,this.scrollDirection=s.layoutParams_structure_scrollDirection,this.currentItemCount=t.galleryItems.length,this.items=[],t.galleryItems.forEach(r=>{this.isItemSupported(r)&&(this.itemRatingMap.has(r.id)||this.itemRatingMap.set(r.id,r.idx),this.items.push(r))})},this.handleEvent=({eventName:t,eventData:i})=>{switch(t){case a.events.ITEM_ACTION_TRIGGERED:this.itemClicked(i.idx);break;case a.events.VIDEO_PAUSED:this.currentPlayingIdx===i.idx&&this.stop(i.idx);break;case a.events.HOVER_SET:this.itemHovered(i);break;case a.events.VIDEO_ENDED:this.videoEnded(i.idx);break;case a.events.VIDEO_PLAYED:this.videoPlayed(i.idx);break;case a.events.VIDEO_ERROR:this.videoErrorReported();break}},this.shouldTriggerAction=(t,i="HOVER")=>this.findItem(t)&&this.shouldTrigger(i),this.itemHovered=t=>{this.shouldTriggerAction(t,"HOVER")&&this.play(t)},this.itemClicked=t=>{this.shouldTriggerAction(t,"CLICK")&&(this.currentPlayingIdx===t?this.stop(t):this.play(t))},this.onScroll=({top:t,left:i})=>{this.top=t>=0?t:this.top,this.left=i>=0?i:this.left,this.currentPlayingIdx===-1?this.autoPlayNextItemByRating({top:this.top,left:this.left}):(this.isCurrentItemStillVisible({top:this.top,left:this.left})||this.stop(this.currentPlayingIdx),this.autoPlayNextItemByRating({top:this.top,left:this.left}))},this.videoEnded=t=>{this.stop(t);const i={top:this.top,left:this.left};this.autoPlayNextItemByRating(i)},this.videoPlayed=t=>{this.currentPlayingIdx!==t&&!this.findItem(t)&&this.play(t),this.lastVideoPlayed=t},this.videoErrorReported=()=>{this.stop()},this.initializePlayState=()=>{this.autoPlayNextItemByRating({top:this.top,left:this.left})},this.autoPlayNextItemByRating=({top:t,left:i})=>{if(!this.shouldTrigger("AUTO"))return;const e={idx:-1,rating:1/0},s={idx:-1,rating:1/0};if(this.items.some(r=>{if(this.isVisible(r,{top:t,left:i})){const d=this.itemRatingMap.get(r.id);return d<=s.rating?(e.idx=s.idx,e.rating=s.rating,s.idx=r.idx,s.rating=d):d<=e.rating&&(e.idx=r.idx,e.rating=d),!1}else return s.idx>=0}),s.idx>=0)if(!this.videoLoop&&s.idx===this.lastVideoPlayed)if(e.idx>=0)this.play(e.idx);else return;else this.play(s.idx);else this.lastVideoPlayed=-2},this.play=t=>{this.setPlayingIdx(t)},this.stop=(t=this.currentPlayingIdx)=>{const i=this.findItem(t);if(i){const e=this.itemRatingMap.get(i.id)+this.currentItemCount;this.itemRatingMap.set(i.id,e)}this.setPlayingIdx(-1)},this.onPlayingIdxChange=()=>{this.setPlayingItem(this.currentPlayingIdx)},this.setPlayingIdx=t=>{this.currentPlayingIdx!==t&&(this.currentPlayingIdx=t,this.onPlayingIdxChange())},this.isCurrentItemStillVisible=({top:t,left:i})=>{const e=this.findItem(this.currentPlayingIdx);return e?this.isVisible(e,{top:t,left:i}):!1},this.isVisible=(t,{top:i,left:e})=>{const s={offsetTop:this.scrollBase||0,scrollY:i,scrollLeft:e},r=(t.offset.top-t.offset.bottom)/2,d=(t.offset.left-t.offset.right)/2,u=p({target:s,scrollBase:this.scrollBase,top:t.offset.top,bottom:t.offset.top+t.style.height,screenHeight:c&&c.innerHeight,padding:r});let f;return this.scrollDirection===a[y.layoutParams.structure.scrollDirection].VERTICAL?f=!0:f=I({target:s,left:t.offset.left,right:t.offset.left+t.style.width,screenWidth:this.galleryWidth||c&&c.innerWidth,padding:d}),u&&f},this.shouldTrigger=t=>this.playTrigger===t,this.findItem=t=>this.items.find(i=>i.idx===t)}}export{m as default};
